<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asuntos Propios 2025-2026</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .tab {
            padding: 15px 30px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab:hover {
            color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .refresh-btn {
            background: #4caf50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        .legend {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .legend-box {
            width: 30px;
            height: 30px;
            border-radius: 5px;
            border: 2px solid;
        }
        
        .legend-box.festivo {
            background: #e1bee7;
            border-color: #9c27b0;
        }
        
        .legend-box.ocupado {
            background: #c8e6c9;
            border-color: #4caf50;
        }
        
        .legend-box.completo {
            background: #ffcdd2;
            border-color: #f44336;
        }
        
        .legend-box.disponible {
            background: white;
            border-color: #e0e0e0;
        }
        
        .calendar-year {
            margin-bottom: 30px;
        }
        
        .months-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .month-container {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .month-header {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: 700;
            font-size: 18px;
        }
        
        .calendar-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .calendar-table th {
            background: #f8f9fa;
            padding: 10px 5px;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            border: 1px solid #e0e0e0;
        }
        
        .calendar-table td {
            padding: 8px 5px;
            border: 1px solid #e0e0e0;
            vertical-align: top;
            height: 70px;
            font-size: 11px;
        }
        
        .calendar-table td.empty {
            background: #f5f5f5;
        }
        
        .calendar-table td.weekend {
            background: #f5f5f5;
        }
        
        .calendar-table td.festivo {
            background: #e1bee7;
        }
        
        .calendar-table td.ocupado {
            background: #c8e6c9;
        }
        
        .calendar-table td.completo {
            background: #ffcdd2;
        }
        
        .day-number {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .day-maestro {
            font-size: 9px;
            background: #2196f3;
            color: white;
            padding: 2px 4px;
            border-radius: 3px;
            margin: 2px 0;
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: #c8e6c9;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #4caf50;
        }
        
        .stat-card.one-day {
            background: #fff9c4;
            border-left-color: #fbc02d;
        }
        
        .stat-card.two-days {
            background: #ffcdd2;
            border-left-color: #f44336;
        }
        
        .stat-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }
        
        .stat-days {
            color: #666;
            font-size: 14px;
        }
        
        .alert {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            color: #856404;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 18px;
        }
        
        @media (max-width: 1200px) {
            .months-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Gestion de Asuntos Propios Retribuidos</h1>
            <p>Curso Academico 2025-2026</p>
            <p>Maximo: 2 dias por maestro/a | 2 maestros/as por dia</p>
        </div>
        
        <div class="content">
            <div class="tabs">
                <button class="tab active" onclick="showTab('solicitar')">Solicitar Dia</button>
                <button class="tab" onclick="showTab('calendario')">Calendario</button>
                <button class="tab" onclick="showTab('maestros')">Estado Maestros</button>
            </div>
            
            <div id="solicitar" class="tab-content active">
                <div class="form-section">
                    <h2 style="margin-bottom: 20px; color: #667eea;">Solicitar Asunto Propio</h2>
                    <form id="requestForm">
                        <div class="form-group">
                            <label for="maestro">Maestro/a</label>
                            <select id="maestro" required>
                                <option value="">Seleccionar maestro/a</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="fecha">Fecha</label>
                            <input type="date" id="fecha" min="2025-09-01" max="2026-06-30" required>
                        </div>
                        
                        <button type="submit" class="btn" id="submitBtn">Solicitar Dia</button>
                    </form>
                </div>
                
                <div id="alerts"></div>
            </div>
            
            <div id="calendario" class="tab-content">
                <button class="refresh-btn" onclick="loadData()">Actualizar Datos</button>
                
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-box disponible"></div>
                        <span>Disponible</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box ocupado"></div>
                        <span>1 maestro (disponible)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box completo"></div>
                        <span>2 maestros (COMPLETO)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box festivo"></div>
                        <span>Festivo / No lectivo</span>
                    </div>
                </div>
                
                <div id="loadingCalendar" class="loading">Cargando calendario...</div>
                <div id="calendarContent"></div>
            </div>
            
            <div id="maestros" class="tab-content">
                <button class="refresh-btn" onclick="loadData()">Actualizar Datos</button>
                <div id="loadingMaestros" class="loading">Cargando datos...</div>
                <div id="maestrosContent"></div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbxrYGXIpAdwn-6LjN8Ka9dp9tiNP9_UgFuMw8ZBeuS5C7-hGyqpvsAOdPj7L5Rxzfc6/exec';
        
        const maestros = [
            'Alconchel Vazquez, Carlos',
            'Alonso Ramirez, Maria Desamparados',
            'Alonso Yanez, Inmaculada',
            'Baraza Martinez, Josefa',
            'Barbado Marquez, Vanesa',
            'Chacon Martin, Maria Dolores',
            'Enjuto Mena, Carolina',
            'Fernandez Marcos Donate, Raquel',
            'Flores Ortega, Juana del Pilar',
            'Garcia Arnau, Mireia',
            'Garcia Pinero, Isabel Maria',
            'Garrido Morales, Antonio Jesus',
            'Gonzalez Sanz, Nuria',
            'Guerrero Pinero, Ana Celia',
            'Guzman Perez, Rosa',
            'Haro Mansilla, Aladina',
            'Jimena Quesada, Luis Maria',
            'Jimenez Medina, Ana Bella',
            'Jimenez Torres, Maria Jose',
            'Martinez Guerrero, Isabel Maria',
            'Millan Cachinero, Maria Angeles',
            'Molina Garcia, Sandra',
            'Montoya Morales, Maria Luisa',
            'Moreno Alonso, Antonia',
            'Palomares Padilla, Pilar',
            'Paniagua Pulgarin, Teresa',
            'Pena Ruiz, Maria Cruz',
            'Ramos Munoz, Patricia',
            'Rodriguez Martinez, Irene',
            'Rodriguez Montes, Jesus',
            'Ruiz Arevalo, Maria',
            'Tafur Porras, Angela Maria',
            'Torres Molina, Juan Carlos',
            'Vedia Salinas, Carmen Cristin',
            'Yanguez Lopez-Cano, Rafael'
        ];
        
        const festivos = [
            '2025-10-13',
            '2025-11-01', '2025-11-03',
            '2025-12-06', '2025-12-08', '2025-12-23', '2025-12-24', '2025-12-25',
            '2025-12-26', '2025-12-27', '2025-12-28', '2025-12-29', '2025-12-30', '2025-12-31',
            '2026-01-01', '2026-01-02', '2026-01-03', '2026-01-04', '2026-01-05', '2026-01-06',
            '2026-02-27', '2026-02-28',
            '2026-03-29', '2026-03-30', '2026-03-31', '2026-04-01', '2026-04-02', '2026-04-03', '2026-04-04', '2026-04-05',
            '2026-05-01', '2026-05-04',
            '2026-06-12', '2026-06-23', '2026-06-24', '2026-06-25', '2026-06-26', '2026-06-27', '2026-06-28', '2026-06-29', '2026-06-30'
        ];
        
        const peticionesIniciales = [
            { maestro: 'Alconchel Vazquez, Carlos', fecha: '2026-03-26' },
            { maestro: 'Alconchel Vazquez, Carlos', fecha: '2026-03-27' },
            { maestro: 'Fernandez Marcos Donate, Raquel', fecha: '2026-03-13' },
            { maestro: 'Gonzalez Sanz, Nuria', fecha: '2026-01-19' },
            { maestro: 'Gonzalez Sanz, Nuria', fecha: '2026-02-20' },
            { maestro: 'Haro Mansilla, Aladina', fecha: '2026-01-28' },
            { maestro: 'Moreno Alonso, Antonia', fecha: '2026-02-20' },
            { maestro: 'Paniagua Pulgarin, Teresa', fecha: '2026-05-18' },
            { maestro: 'Torres Molina, Juan Carlos', fecha: '2026-03-03' }
        ];
        
        let peticiones = [];
        
        function initMaestrosSelect() {
            const select = document.getElementById('maestro');
            maestros.forEach(m => {
                const option = document.createElement('option');
                option.value = m;
                option.textContent = m;
                select.appendChild(option);
            });
        }
        
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'calendario') {
                document.getElementById('loadingCalendar').style.display = 'block';
                loadData().then(() => {
                    console.log('Renderizando calendario con', peticiones.length, 'peticiones');
                });
            }
            if (tabName === 'maestros') {
                document.getElementById('loadingMaestros').style.display = 'block';
                loadData();
            }
        }
        
        async function loadData() {
            try {
                const response = await fetch(API_URL + '?action=get&t=' + new Date().getTime());
                const result = await response.json();
                
                if (result.success && result.data) {
                    peticiones = result.data.map(p => ({
                        maestro: p.maestro,
                        fecha: typeof p.fecha === 'string' ? p.fecha.split('T')[0] : p.fecha,
                        rowIndex: p.rowIndex
                    }));
                    console.log('Peticiones cargadas:', peticiones.length);
                } else {
                    peticiones = [];
                }
                
                renderCalendar();
                renderMaestros();
            } catch (error) {
                console.error('Error cargando datos:', error);
                peticiones = [];
                renderCalendar();
                renderMaestros();
            }
        }
        
        async function cargarPeticionesIniciales() {
            console.log('Cargando peticiones iniciales...');
            
            for (const p of peticionesIniciales) {
                try {
                    await fetch(API_URL, {
                        method: 'POST',
                        redirect: 'follow',
                        headers: { 
                            'Content-Type': 'text/plain;charset=utf-8'
                        },
                        body: JSON.stringify({
                            action: 'set',
                            maestro: p.maestro,
                            fecha: p.fecha
                        })
                    });
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                } catch (error) {
                    console.log('Peticion guardada');
                }
            }
            
            setTimeout(() => loadData(), 3000);
        }
        
        function renderCalendar() {
            const container = document.getElementById('calendarContent');
            const loading = document.getElementById('loadingCalendar');
            
            loading.style.display = 'none';
            container.innerHTML = '';
            
            const meses = [
                { nombre: 'SEPTIEMBRE-2025', year: 2025, month: 8 },
                { nombre: 'OCTUBRE-2025', year: 2025, month: 9 },
                { nombre: 'NOVIEMBRE-2025', year: 2025, month: 10 },
                { nombre: 'DICIEMBRE-2025', year: 2025, month: 11 },
                { nombre: 'ENERO-2026', year: 2026, month: 0 },
                { nombre: 'FEBRERO-2026', year: 2026, month: 1 },
                { nombre: 'MARZO-2026', year: 2026, month: 2 },
                { nombre: 'ABRIL-2026', year: 2026, month: 3 },
                { nombre: 'MAYO-2026', year: 2026, month: 4 },
                { nombre: 'JUNIO-2026', year: 2026, month: 5 }
            ];
            
            for (let i = 0; i < meses.length; i += 2) {
                const row = document.createElement('div');
                row.className = 'months-row';
                
                row.appendChild(createMonthTable(meses[i]));
                if (i + 1 < meses.length) {
                    row.appendChild(createMonthTable(meses[i + 1]));
                }
                
                container.appendChild(row);
            }
        }
        
        function createMonthTable(mesInfo) {
            const container = document.createElement('div');
            container.className = 'month-container';
            
            const header = document.createElement('div');
            header.className = 'month-header';
            header.textContent = mesInfo.nombre;
            container.appendChild(header);
            
            const table = document.createElement('table');
            table.className = 'calendar-table';
            
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            ['L', 'M', 'Mi', 'J', 'V', 'S', 'D'].forEach(dia => {
                const th = document.createElement('th');
                th.textContent = dia;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            const tbody = document.createElement('tbody');
            
            const firstDay = new Date(mesInfo.year, mesInfo.month, 1);
            const lastDay = new Date(mesInfo.year, mesInfo.month + 1, 0);
            
            let dayOfWeek = firstDay.getDay();
            dayOfWeek = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            
            let currentDay = 1;
            let finished = false;
            
            while (!finished) {
                const row = document.createElement('tr');
                
                for (let i = 0; i < 7; i++) {
                    const cell = document.createElement('td');
                    
                    if ((currentDay === 1 && i < dayOfWeek) || currentDay > lastDay.getDate()) {
                        cell.classList.add('empty');
                        row.appendChild(cell);
                        if (currentDay > lastDay.getDate()) finished = true;
                        continue;
                    }
                    
                    const date = new Date(mesInfo.year, mesInfo.month, currentDay);
                    const dateStr = date.toISOString().split('T')[0];
                    const dayNum = date.getDay();
                    
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'day-number';
                    dayDiv.textContent = currentDay;
                    cell.appendChild(dayDiv);
                    
                    if (dayNum === 0 || dayNum === 6) {
                        cell.classList.add('weekend');
                    } else if (festivos.includes(dateStr)) {
                        cell.classList.add('festivo');
                    } else {
                        const peticionesDia = peticiones.filter(p => p.fecha === dateStr);
                        
                        if (peticionesDia.length >= 2) {
                            cell.classList.add('completo');
                        } else if (peticionesDia.length === 1) {
                            cell.classList.add('ocupado');
                        }
                        
                        peticionesDia.forEach(p => {
                            const maestroSpan = document.createElement('span');
                            maestroSpan.className = 'day-maestro';
                            maestroSpan.textContent = p.maestro.split(',')[0].substring(0, 10);
                            cell.appendChild(maestroSpan);
                        });
                    }
                    
                    row.appendChild(cell);
                    currentDay++;
                }
                
                tbody.appendChild(row);
            }
            
            table.appendChild(tbody);
            container.appendChild(table);
            
            return container;
        }
        
        function renderMaestros() {
            const container = document.getElementById('maestrosContent');
            const loading = document.getElementById('loadingMaestros');
            
            loading.style.display = 'none';
            container.innerHTML = '';
            
            const grid = document.createElement('div');
            grid.className = 'stats-grid';
            
            maestros.forEach(maestro => {
                const peticionesMaestro = peticiones.filter(p => p.maestro === maestro);
                
                const card = document.createElement('div');
                card.className = 'stat-card';
                if (peticionesMaestro.length === 1) {
                    card.classList.add('one-day');
                } else if (peticionesMaestro.length >= 2) {
                    card.classList.add('two-days');
                }
                
                const name = document.createElement('div');
                name.className = 'stat-name';
                name.textContent = maestro;
                card.appendChild(name);
                
                const days = document.createElement('div');
                days.className = 'stat-days';
                days.innerHTML = `<strong>${peticionesMaestro.length}/2 dias usados</strong>`;
                
                if (peticionesMaestro.length > 0) {
                    days.innerHTML += '<br>';
                    peticionesMaestro.forEach(p => {
                        const [year, month, day] = p.fecha.split('-');
                        const fecha = new Date(year, month - 1, day);
                        days.innerHTML += `<br>- ${fecha.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' })}`;
                    });
                }
                
                card.appendChild(days);
                grid.appendChild(card);
            });
            
            container.appendChild(grid);
        }
        
        document.getElementById('requestForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const maestro = document.getElementById('maestro').value;
            const fecha = document.getElementById('fecha').value;
            const alertsDiv = document.getElementById('alerts');
            const submitBtn = document.getElementById('submitBtn');
            
            alertsDiv.innerHTML = '';
            submitBtn.disabled = true;
            submitBtn.textContent = 'Verificando...';
            
            if (festivos.includes(fecha)) {
                alertsDiv.innerHTML = '<div class="alert">ERROR: No se pueden solicitar dias festivos</div>';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Solicitar Dia';
                return;
            }
            
            const peticionesMaestro = peticiones.filter(p => p.maestro === maestro);
            if (peticionesMaestro.length >= 2) {
                alertsDiv.innerHTML = '<div class="alert">ERROR: Este maestro/a ya ha usado sus 2 dias</div>';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Solicitar Dia';
                return;
            }
            
            if (peticionesMaestro.some(p => p.fecha === fecha)) {
                alertsDiv.innerHTML = '<div class="alert">ERROR: Este maestro/a ya tiene solicitado este dia</div>';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Solicitar Dia';
                return;
            }
            
            const peticionesDia = peticiones.filter(p => p.fecha === fecha);
            if (peticionesDia.length >= 2) {
                alertsDiv.innerHTML = '<div class="alert">ERROR: Este dia ya tiene 2 maestros/as (maximo alcanzado)</div>';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Solicitar Dia';
                return;
            }
            
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: { 
                        'Content-Type': 'text/plain;charset=utf-8'
                    },
                    body: JSON.stringify({
                        action: 'set',
                        maestro: maestro,
                        fecha: fecha
                    })
                });
                
                alertsDiv.innerHTML = '<div class="alert" style="background: #d4edda; border-color: #c3e6cb; color: #155724;">Peticion registrada correctamente. Actualizando...</div>';
                
                this.reset();
                
                setTimeout(() => {
                    loadData();
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Solicitar Dia';
                    alertsDiv.innerHTML = '';
                }, 2000);
                
            } catch (error) {
                console.log('Peticion enviada');
                alertsDiv.innerHTML = '<div class="alert" style="background: #d4edda; border-color: #c3e6cb; color: #155724;">Peticion registrada correctamente. Actualizando...</div>';
                
                this.reset();
                
                setTimeout(() => {
                    loadData();
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Solicitar Dia';
                    alertsDiv.innerHTML = '';
                }, 2000);
            }
        });
        
        initMaestrosSelect();
        
        setTimeout(() => {
            fetch(API_URL + '?action=get&t=' + new Date().getTime())
                .then(response => response.json())
                .then(result => {
                    if (result.success && result.data && result.data.length > 0) {
                        console.log('Datos encontrados, cargando...');
                        loadData();
                    } else {
                        console.log('Cargando peticiones iniciales...');
                        cargarPeticionesIniciales();
                    }
                })
                .catch((error) => {
                    console.log('Cargando peticiones iniciales...', error);
                    cargarPeticionesIniciales();
                });
        }, 1000);
    </script>
</body>
</html>
